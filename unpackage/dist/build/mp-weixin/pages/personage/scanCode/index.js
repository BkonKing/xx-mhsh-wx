(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/personage/scanCode/index"],{"474e":function(t,e,n){"use strict";n.r(e);var a=n("5857"),o=n("873f");for(var c in o)"default"!==c&&function(t){n.d(e,t,(function(){return o[t]}))}(c);n("ed92");var i,r=n("f0c5"),u=Object(r["a"])(o["default"],a["b"],a["c"],!1,null,"da751380",null,!1,a["a"],i);e["default"]=u.exports},5857:function(t,e,n){"use strict";n.d(e,"b",(function(){return o})),n.d(e,"c",(function(){return c})),n.d(e,"a",(function(){return a}));var a={uniNavBar:function(){return n.e("uni_modules/uni-nav-bar/components/uni-nav-bar/uni-nav-bar").then(n.bind(null,"35c2"))}},o=function(){var t=this,e=t.$createElement;t._self._c},c=[]},"873f":function(t,e,n){"use strict";n.r(e);var a=n("f62d"),o=n.n(a);for(var c in a)"default"!==c&&function(t){n.d(e,t,(function(){return a[t]}))}(c);e["default"]=o.a},bf58:function(t,e,n){},e868:function(t,e,n){"use strict";(function(t){n("f38a");a(n("66fd"));var e=a(n("474e"));function a(t){return t&&t.__esModule?t:{default:t}}wx.__webpack_require_UNI_MP_PLUGIN__=n,t(e.default)}).call(this,n("543d")["createPage"])},ed92:function(t,e,n){"use strict";var a=n("bf58"),o=n.n(a);o.a},f62d:function(t,e,n){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var a=n("26cb"),o=n("c92a"),c=n("3b74"),i=n("ec93");function r(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,a)}return n}function u(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?r(Object(n),!0).forEach((function(e){s(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function s(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var l={data:function(){return{codeId:"",current:0,tabs:[{value:1,name:"扫一扫"},{value:2,name:"付款码"},{value:3,name:"收款码"}],paymentCodeImg:"",collectCodeImg:"",timer:null}},computed:u(u({},(0,a.mapGetters)(["userInfo"])),{},{shopId:function(){return this.userInfo.shops_id}}),onLoad:function(t){this.current=parseInt(t.current)||1},onUnload:function(){this.timer&&clearTimeout(this.timer)},methods:{switchTab:function(t){this.current=t,this.timer&&clearTimeout(this.timer)},scanCode:function(){var e=this;t.scanCode({onlyFromCamera:!0,success:function(t){var n=t.result;n&&e.scanSuccess(n)}})},scanSuccess:function(t){var e=t.split("|"),n=e[0],a={shoukuan:"collectScan",fukuan:"paymentScan",shangpuyhq:"getShopScanPermission"},o=a[n];o&&this[o](t,e)},getShopScanPermission:function(e){var n=this;this.shopId&&(0,c.getShopScanPermission)({shops_id:this.shopId}).then((function(t){var a=t.data;+a.is_scan&&n.goShopCouponVerification(e)})).catch((function(){t.showToast({title:"您没有核销权限",icon:"none"})}))},goShopCouponVerification:function(t){this.$router.push({path:"/pages/personage/shop/verification",query:{codeInfo:t}})},getPaymentCode:function(){var t=this;(0,o.getPaymentCode)().then((function(e){var n=e.data,a=n.url,o=n.code_id;t.paymentCodeImg=a,t.codeId=o,t.pollingPayment()}))},getCollectCode:function(){var t=this;(0,o.getCollectCode)().then((function(e){var n=e.data,a=n.url,o=n.old_code_id;t.collectCodeImg=a,t.codeId=o,t.pollingCollect()}))},pollingPayment:function(){var t=this;2===this.current&&(this.timer&&clearTimeout(this.timer),this.timer=setTimeout((function(){t.paymentStatus()}),3e3))},pollingCollect:function(){var t=this;3===this.current&&(this.timer&&clearTimeout(this.timer),this.timer=setTimeout((function(){t.collectStatus()}),3e3))},paymentStatus:function(){var e=this;(0,o.paymentStatus)({code_id:this.codeId}).then((function(n){var a=n.data,o=a.is_pay,c=a.credits,i=a.avatar,r=a.realname,u=a.mobile,s=a.remarks;"1"!=o?c&&"0"!=c?e.$router.push({path:"/pages/credit/payment",query:{type:"3",value:e.codeId,avatar:i,realname:r,mobile:u,credits:c,remarks:s}}):e.pollingPayment():t.showModal({title:"支付成功",showCancel:!1})}))},collectStatus:function(){var e=this;(0,o.collectStatus)({old_code_id:this.codeId}).then((function(n){var a=n.data;a&&"1"==a.is_pay?t.showModal({content:"获得".concat(a.credits,"幸福币"),showCancel:!1,success:function(t){t.confirm&&e.getCollectCode()}}):e.pollingCollect()}))},collectScan:function(e,n){var a=this;(0,o.collectScan)({code_info:e}).then((function(t){var e=t.data,n=e.check_status,o=(e.is_pay,e.avatar),c=e.realname,i=e.mobile,r=e.code_id;n&&a.$router.push({path:"/pages/credit/payment",query:{type:"1",value:r,avatar:o,realname:c,mobile:i}})})).catch((function(e){t.showModal({title:e.message,showCancel:!1})}))},paymentScan:function(e,n){var a=this;(0,o.paymentScan)({code_info:e}).then((function(e){var o=e.data,c=o.check_status,i=o.is_pay,r=o.avatar,u=o.realname,s=o.mobile;c?0==i?a.$router.push({path:"/pages/credit/payment",query:{type:"2",value:n[1],avatar:r,realname:u,mobile:s}}):t.showToast({title:"对方已付款",icon:"none",duration:2e3}):t.showToast({title:"扫码失败，二维码可能过期",icon:"none",duration:2e3})})).catch((function(e){t.showModal({title:e.message,showCancel:!1})}))},goBack:function(){this.$router.go(-1)}},watch:{current:function(t){var e=this;1===t?(0,i.handlePermission)({name:"camera",title:"摄像头未开启",message:"为了提供更好服务，需要您摄像头"}).then((function(){e.scanCode()})):2===t?this.getPaymentCode():3===t&&this.getCollectCode()}}};e.default=l}).call(this,n("543d")["default"])}},[["e868","common/runtime","common/vendor"]]]);