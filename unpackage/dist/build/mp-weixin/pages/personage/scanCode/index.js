(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/personage/scanCode/index"],{"1c93":function(t,e,n){"use strict";var a=n("b64c"),o=n.n(a);o.a},"474e":function(t,e,n){"use strict";n.r(e);var a=n("6b56"),o=n("873f");for(var r in o)"default"!==r&&function(t){n.d(e,t,(function(){return o[t]}))}(r);n("1c93");var i,c=n("f0c5"),u=Object(c["a"])(o["default"],a["b"],a["c"],!1,null,"dfff8b58",null,!1,a["a"],i);e["default"]=u.exports},"6b56":function(t,e,n){"use strict";n.d(e,"b",(function(){return o})),n.d(e,"c",(function(){return r})),n.d(e,"a",(function(){return a}));var a={uniNavBar:function(){return n.e("uni_modules/uni-nav-bar/components/uni-nav-bar/uni-nav-bar").then(n.bind(null,"35c2"))}},o=function(){var t=this,e=t.$createElement;t._self._c},r=[]},"873f":function(t,e,n){"use strict";n.r(e);var a=n("f62d"),o=n.n(a);for(var r in a)"default"!==r&&function(t){n.d(e,t,(function(){return a[t]}))}(r);e["default"]=o.a},b64c:function(t,e,n){},e868:function(t,e,n){"use strict";(function(t){n("f38a");a(n("66fd"));var e=a(n("474e"));function a(t){return t&&t.__esModule?t:{default:t}}wx.__webpack_require_UNI_MP_PLUGIN__=n,t(e.default)}).call(this,n("543d")["createPage"])},f62d:function(t,e,n){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var a=s(n("a34a")),o=n("26cb"),r=n("c92a"),i=n("3b74"),c=n("ec93"),u=n("beeb");function s(t){return t&&t.__esModule?t:{default:t}}function l(t,e,n,a,o,r,i){try{var c=t[r](i),u=c.value}catch(s){return void n(s)}c.done?e(u):Promise.resolve(u).then(a,o)}function d(t){return function(){var e=this,n=arguments;return new Promise((function(a,o){var r=t.apply(e,n);function i(t){l(r,a,o,i,c,"next",t)}function c(t){l(r,a,o,i,c,"throw",t)}i(void 0)}))}}function f(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,a)}return n}function h(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?f(Object(n),!0).forEach((function(e){p(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):f(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function p(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var m={data:function(){return{codeId:"",current:0,tabs:[{value:1,name:"扫一扫"},{value:2,name:"付款码"},{value:3,name:"收款码"}],paymentCodeImg:"",collectCodeImg:"",timer:null}},computed:h(h({},(0,o.mapGetters)(["userInfo"])),{},{shopId:function(){return this.userInfo.shops_id}}),onLoad:function(t){this.current=parseInt(t.current)||1},onUnload:function(){this.timer&&clearTimeout(this.timer)},methods:{switchTab:function(t){this.current=t,this.timer&&clearTimeout(this.timer)},scanCode:function(){var e=this;t.scanCode({onlyFromCamera:!0,success:function(t){var n=t.result;n&&e.scanSuccess(n)}})},scanSuccess:function(t){console.log(t);var e=t.split("|"),n=e[0],a={shoukuan:"collectScan",fukuan:"paymentScan",shangpuyhq:"getShopScanPermission",awardLogCode:"getAwardScan",awardPreviewCode:"previewAward"},o=a[n];o&&this[o](t,e)},getShopScanPermission:function(e){var n=this;this.shopId&&(0,i.getShopScanPermission)({shops_id:this.shopId}).then((function(t){var a=t.data;+a.is_scan&&n.goShopCouponVerification(e)})).catch((function(){t.showToast({title:"您没有核销权限",icon:"none"})}))},goShopCouponVerification:function(t){this.$router.push({path:"/pages/personage/shop/verification",query:{codeInfo:t}})},getAwardScan:function(t,e){var n=this;return d(a.default.mark((function t(){var o,r,i;return a.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return o=e[1],t.next=3,(0,u.getAwardScan)({award_log_id:o});case 3:r=t.sent,i=r.data,i.is_power&&n.goAwardVerification(o);case 6:case"end":return t.stop()}}),t)})))()},previewAward:function(t,e){var n=e[1];this.$router.push({path:"/pages/activity/award/index",query:{id:n,isPreview:1}})},goAwardVerification:function(t){this.$router.push({path:"/pages/activity/award/verification",query:{id:t}})},getPaymentCode:function(){var t=this;(0,r.getPaymentCode)().then((function(e){var n=e.data,a=n.url,o=n.code_id;t.paymentCodeImg=a,t.codeId=o,t.pollingPayment()}))},getCollectCode:function(){var t=this;(0,r.getCollectCode)().then((function(e){var n=e.data,a=n.url,o=n.old_code_id;t.collectCodeImg=a,t.codeId=o,t.pollingCollect()}))},pollingPayment:function(){var t=this;2===this.current&&(this.timer&&clearTimeout(this.timer),this.timer=setTimeout((function(){t.paymentStatus()}),3e3))},pollingCollect:function(){var t=this;3===this.current&&(this.timer&&clearTimeout(this.timer),this.timer=setTimeout((function(){t.collectStatus()}),3e3))},paymentStatus:function(){var e=this;(0,r.paymentStatus)({code_id:this.codeId}).then((function(n){var a=n.data,o=a.is_pay,r=a.credits,i=a.avatar,c=a.realname,u=a.mobile,s=a.remarks;"1"!=o?r&&"0"!=r?e.$router.push({path:"/pages/credit/payment",query:{type:"3",value:e.codeId,avatar:i,realname:c,mobile:u,credits:r,remarks:s}}):e.pollingPayment():t.showModal({title:"支付成功",showCancel:!1})}))},collectStatus:function(){var e=this;(0,r.collectStatus)({old_code_id:this.codeId}).then((function(n){var a=n.data;a&&"1"==a.is_pay?t.showModal({content:"获得".concat(a.credits,"幸福币"),showCancel:!1,success:function(t){t.confirm&&e.getCollectCode()}}):e.pollingCollect()}))},collectScan:function(e,n){var a=this;(0,r.collectScan)({code_info:e}).then((function(t){var e=t.data,n=e.check_status,o=(e.is_pay,e.avatar),r=e.realname,i=e.mobile,c=e.code_id;n&&a.$router.push({path:"/pages/credit/payment",query:{type:"1",value:c,avatar:o,realname:r,mobile:i}})})).catch((function(e){t.showModal({title:e.message,showCancel:!1})}))},paymentScan:function(e,n){var a=this;(0,r.paymentScan)({code_info:e}).then((function(e){var o=e.data,r=o.check_status,i=o.is_pay,c=o.avatar,u=o.realname,s=o.mobile;r?0==i?a.$router.push({path:"/pages/credit/payment",query:{type:"2",value:n[1],avatar:c,realname:u,mobile:s}}):t.showToast({title:"对方已付款",icon:"none",duration:2e3}):t.showToast({title:"扫码失败，二维码可能过期",icon:"none",duration:2e3})})).catch((function(e){t.showModal({title:e.message,showCancel:!1})}))},goBack:function(){this.$router.go(-1)}},watch:{current:function(t){var e=this;1===t?(0,c.handlePermission)({name:"camera",title:"摄像头未开启",message:"为了提供更好服务，需要您摄像头"}).then((function(){e.scanCode()})):2===t?this.getPaymentCode():3===t&&this.getCollectCode()}}};e.default=m}).call(this,n("543d")["default"])}},[["e868","common/runtime","common/vendor"]]]);